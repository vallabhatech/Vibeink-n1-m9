<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Add Manga - VibeInk</title>
    <link rel="website icon" type="image/png" href="./Logo2.png" />
    <link rel="stylesheet" href="style.css" />
    <style>
      .form-container {
        max-width: 800px;
        margin: 120px auto 40px;
        padding: 20px;
        background-color: #f5f5f5;
        border-radius: 10px;
        margin-top: 0px;
      }

      .form-title {
        text-align: center;
        margin-bottom: 20px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      label {
        display: block;
        font-weight: bold;
        margin-bottom: 5px;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
      }

      .ingredient-section,
      .step-section {
        background-color: #e7d3bb;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 5px;
      }

      .ingredient-list,
      .step-list {
        margin-bottom: 10px;
      }

      .ingredient-item,
      .step-item {
        display: flex;
        margin-bottom: 5px;
      }

      .macros-item {
        display: flex;
        margin-bottom: 5px;
        gap: 10px;
      }

      .macros-item input {
        flex: 1;
      }

      .remove-btn {
        background-color: #ff6b6b;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 8px 12px;
        margin-left: 10px;
        cursor: pointer;
      }

      .add-btn {
        background-color: #4ecdc4;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 8px 12px;
        cursor: pointer;
        margin-right: 10px;
      }

      .section-controls {
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
      }

      .submit-btn {
        background-color: #e7d3bb;
        color: black;
        border: none;
        border-radius: 4px;
        padding: 12px 24px;
        font-size: 18px;
        cursor: pointer;
        display: block;
        margin: 20px auto 0;
        transition: background-color 0.3s;
      }

      .submit-btn:hover {
        background-color: #d4b99a;
      }

      .hint {
        font-size: 14px;
        color: #666;
        margin-top: 2px;
      }

      /* Darkmode styles */
      .dark-mode .form-container {
        background-color: #2d2d2d;
        color: #ffffff;
      }

      .dark-mode input,
      .dark-mode select,
      .dark-mode textarea {
        background-color: #404040;
        color: #ffffff;
        border-color: #666;
      }

      .dark-mode .ingredient-section,
      .dark-mode .step-section {
        background-color: #404040;
      }

      .dark-mode .submit-btn {
        background-color: #404040;
        color: #ffffff;
      }

      .dark-mode .submit-btn:hover {
        background-color: #666;
      }
    </style>
  </head>

  <body>
    <header class="header">
      <div class="logo-container">
        <img src="./Logo2.png" alt="VibeInk Logo" class="logo-img" />
        <div class="name-tagline">
          <h1 class="logo-text" style="font-family: 'Times New Roman', Times, serif; font-size: xx-large;">
            VibeInk
          </h1>
          <h3>Read It, Feel It, Live It..</h3>
        </div>
      </div>

      <div class="profile-container">
        <button id="toggle-button" style="margin-left: 20px">
          <!-- Dark mode icon -->
          <svg id="dark-icon" xmlns="http://www.w3.org/2000/svg" height="24px" width="24px" viewBox="0 -960 960 960">
            <path d="M480-280q-83 0-141.5-58.5T280-480q0-83 58.5-141.5T480-680q83 0 141.5 58.5T680-480q0 83-58.5 141.5T480-280Z..." />
          </svg>

          <!-- Light mode icon -->
          <svg id="light-icon" xmlns="http://www.w3.org/2000/svg" height="24px" width="24px" viewBox="0 -960 960 960" style="display: none">
            <path d="M480-120q-150 0-255-105T120-480q0-150 105-255t255-105q14 0 27.5 1t26.5 3q-41 29-65.5 75.5T444-660..." />
          </svg>
        </button>

        <div class="username-display" id="headerUsername">User</div>
        <img src="./Profile.jpg" alt="Profile" class="profile-img" id="profileImg" />

        <div class="profile-dropdown" id="profileDropdown">
          <div class="dropdown-username" id="username">Loading...</div>
          <div class="dropdown-divider"></div>
          <div class="dropdown-item" id="resetPasswordBtn">Reset Password</div>
          <div class="dropdown-divider"></div>
          <div class="dropdown-item" id="signoutBtn">Sign Out</div>
        </div>
      </div>
    </header>

    <!-- Back Button -->
    <a href="./home.html" class="back-btn">
      <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" viewBox="0 0 16 16">
        <path fill-rule="evenodd" d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8m15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-4.5-.5..." />
      </svg>
    </a>

    <!-- Add Manga Form -->
    <div class="form-container">
      <h2 class="form-title">Add New Manga</h2>
      <form id="manga-form">
        <!-- Basic Info -->
        <div class="form-group">
          <label for="manga-title">Manga Title*</label>
          <input type="text" id="manga-title" required />
        </div>

        <div class="form-group">
          <label for="manga-genre">Genre*</label>
          <select id="manga-genre" required>
            <option value="">Select a Genre</option>
            <option value="fantasy">Fantasy</option>
            <option value="romance">Romance</option>
            <option value="comedy">Comedy</option>
            <option value="action">Action</option>
            <option value="drama">Drama</option>
          </select>
        </div>

        <div class="form-group">
          <label for="manga-cover">Cover Image URL</label>
          <input type="text" id="manga-cover" placeholder="https://example.com/image.jpg" />
          <p class="hint">Leave blank to use a placeholder image</p>
        </div>

        <div class="form-group">
          <label for="manga-synopsis">Synopsis*</label>
          <textarea id="manga-synopsis" rows="4" placeholder="Write a brief synopsis..." required></textarea>
        </div>

        <!-- Chapters -->
        <h3>Chapters*</h3>
        <div id="chapters-container">
          <div class="chapter-item">
            <input type="text" class="chapter-title" placeholder="Chapter Title" />
            <textarea class="chapter-content" rows="3" placeholder="Chapter Content"></textarea>
            <button type="button" class="remove-btn">Remove</button>
          </div>
        </div>

        <button type="button" id="add-chapter" class="add-btn">Add Chapter</button>
        <button type="submit" class="submit-btn">Add Manga</button>
      </form>
    </div>

    <!-- JS Scripts -->
    <script type="module">
      import { addManga, getCurrentUser } from "./firebase.js";

      document.addEventListener("DOMContentLoaded", async () => {
        const user = await getCurrentUser();
        if (!user) {
          alert("You need to log in to add manga");
          window.location.href = "login.html";
          return;
        }
        setupForm();
      });

      function setupForm() {
        document.getElementById("add-chapter").addEventListener("click", addChapter);

        document.getElementById("manga-form").addEventListener("submit", async (e) => {
          e.preventDefault();
          try {
            const mangaData = collectFormData();

            if (!mangaData.title || !mangaData.genre || !mangaData.synopsis) {
              alert("Please fill in all required fields");
              return;
            }

            const user = await getCurrentUser();
            mangaData.userId = user.uid;
            mangaData.createdAt = new Date().toISOString();

            const result = await addManga(mangaData);

            if (result.success) {
              alert("Manga added successfully!");
              window.location.href = `manga-detail.html?id=${result.id}`;
            } else {
              throw new Error(result.error);
            }
          } catch (error) {
            console.error("Error adding manga:", error);
            alert(`Failed to add manga: ${error.message}`);
          }
        });
      }

      function addChapter() {
        const container = document.getElementById("chapters-container");
        const chapter = document.createElement("div");
        chapter.className = "chapter-item";
        chapter.innerHTML = `
          <input type="text" class="chapter-title" placeholder="Chapter Title" />
          <textarea class="chapter-content" rows="3" placeholder="Chapter Content"></textarea>
          <button type="button" class="remove-btn">Remove</button>
        `;
        container.appendChild(chapter);

        chapter.querySelector(".remove-btn").addEventListener("click", () => {
          chapter.remove();
        });
      }

      function collectFormData() {
        const manga = {
          title: document.getElementById("manga-title").value.trim(),
          genre: document.getElementById("manga-genre").value,
          coverUrl: document.getElementById("manga-cover").value.trim(),
          synopsis: document.getElementById("manga-synopsis").value.trim(),
          chapters: [],
        };

        const chapters = document.querySelectorAll(".chapter-item");
        chapters.forEach((chapter) => {
          const title = chapter.querySelector(".chapter-title").value.trim();
          const content = chapter.querySelector(".chapter-content").value.trim();

          if (title && content) {
            manga.chapters.push({ title, content });
          }
        });

        return manga;
      }
    </script>
  </body>
</html>
